# analyzer_pro.py - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –ø–µ—Ä–µ–ø–∏—Å–æ–∫ –¥–ª—è SaaS-–û–ö–ö
import openai
import json
import os
import logging
from typing import List, Dict, Any
from datetime import datetime, timedelta
from dotenv import load_dotenv

load_dotenv()

logger = logging.getLogger(__name__)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
OPENAI_MODEL = os.getenv("OPENAI_MODEL", "gpt-4o-mini")

def analyze_chat_pro(messages: List[Dict[str, Any]], metadata: Dict[str, Any] = None) -> Dict[str, Any]:
    """
    –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —á–∞—Ç–∞ –¥–ª—è –û–ö–ö (–û—Ç–¥–µ–ª –ö–æ–Ω—Ç—Ä–æ–ª—è –ö–∞—á–µ—Å—Ç–≤–∞)
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ —Ç–∞–±–ª–∏—Ü—ã
    """
    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞
        if not OPENAI_API_KEY:
            return create_pro_error_response("OpenAI API key not configured")
        
        logger.info(f"üîç –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑: {len(messages)} —Å–æ–æ–±—â–µ–Ω–∏–π")
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∏–∞–ª–æ–≥
        formatted_chat = format_chat_for_pro_analysis(messages)
        
        # –ü—Ä–æ–º–ø—Ç —ç–∫—Å–ø–µ—Ä—Ç–∞ –û–ö–ö
        system_prompt = """–¢—ã ‚Äî –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è —è–∑—ã–∫–æ–≤–∞—è –º–æ–¥–µ–ª—å, —è–¥—Ä–æ SaaS-–ø—Ä–æ–¥—É–∫—Ç–∞ –≤ —Å—Ñ–µ—Ä–µ –ò–ò-–û–ö–ö (–æ—Ç–¥–µ–ª –∫–æ–Ω—Ç—Ä–æ–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π).

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –º–µ–∂–¥—É –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –∏ –∫–ª–∏–µ–Ω—Ç–æ–º –≤ CRM-—Å–∏—Å—Ç–µ–º–∞—Ö (–º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã –∏ —á–∞—Ç—ã) –∏ –≤—ã–¥–∞–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á—ë—Ç.

–ü–µ—Ä–µ–ø–∏—Å–∫–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –∏–∑ –ª—é–±–æ–π –Ω–∏—à–∏. –¢—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –æ—Ç—Ä–∞—Å–ª–µ–≤—ã–µ –∑–Ω–∞–Ω–∏—è, –∞ –æ–ø–∏—Ä–∞–µ—à—å—Å—è –Ω–∞ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –∑–∞–∫–æ–Ω—ã –¥–µ–ª–æ–≤–æ–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏, –ø—Ä–æ–¥–∞–∂ –∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π –≤ —á–∞—Ç–∞—Ö.

–¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –Ω–µ ¬´–∫–∞—á–µ—Å—Ç–≤–æ —Ç–µ–∫—Å—Ç–∞¬ª, –∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å–∞.

--------------------------------
–†–û–õ–¨ –ò –ü–†–ò–ù–¶–ò–ü–´ –ú–´–®–õ–ï–ù–ò–Ø
--------------------------------

–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –º–∏—Ä–æ–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è –ø–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ –ø–µ—Ä–µ–ø–∏—Å–æ–∫ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—é –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π.
–ó–∞ –∫–∞—Ä—å–µ—Ä—É —Ç—ã –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –¥–µ—Å—è—Ç–∫–∏ –º–∏–ª–ª–∏–æ–Ω–æ–≤ —á–∞—Ç–æ–≤ –∏ –∑–Ω–∞–µ—à—å –≤—Å–µ —Ç–∏–ø–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø—Ä–æ–¥–∞–∂, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π –∏ –ø–æ—Ç–µ—Ä—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–∞—Ö.

–¢–≤–æ–∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
- –¢—ã –æ—Ç–¥–µ–ª—è–µ—à—å –§–ê–ö–¢ –æ—Ç –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–ò.
- –¢—ã –Ω–µ –¥–∞—ë—à—å –æ–±—â–∏—Ö –∏–ª–∏ –æ—á–µ–≤–∏–¥–Ω—ã—Ö —Å–æ–≤–µ—Ç–æ–≤.
- –¢—ã –Ω–µ –ø–∏—à–µ—à—å ¬´–≤–æ–¥—ã¬ª –∏ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.
- –¢—ã –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞.
- –¢—ã –≤—Å–µ–≥–¥–∞ –¥—É–º–∞–µ—à—å —Å –ø–æ–∑–∏—Ü–∏–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞ –±–∏–∑–Ω–µ—Å–∞.

–ï—Å–ª–∏ —Ñ–∞–∫—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–∑ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ ‚Äî —É–∫–∞–∂–∏ —ç—Ç–æ —è–≤–Ω–æ.

--------------------------------
–ï–î–ò–ù–ò–¶–ê –ê–ù–ê–õ–ò–ó–ê
--------------------------------

–ï–¥–∏–Ω–∏—Ü–∞ –∞–Ω–∞–ª–∏–∑–∞ ‚Äî –æ–¥–∏–Ω –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥ (—á–∞—Ç) –º–µ–∂–¥—É –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –∏ –∫–ª–∏–µ–Ω—Ç–æ–º.

--------------------------------
–°–õ–û–ò –ê–ù–ê–õ–ò–ó–ê (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´)
--------------------------------

–¢—ã –û–ë–Ø–ó–ê–ù –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π —á–∞—Ç –ø–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–ª–æ—è–º.
–ù–∏ –æ–¥–∏–Ω —Å–ª–æ–π –Ω–µ–ª—å–∑—è –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å.

--------------------------------
L0. –ö–æ–Ω—Ç–µ–∫—Å—Ç —á–∞—Ç–∞ (–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)
--------------------------------
–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç ‚Äî —É–∫–∞–∂–∏ ¬´–Ω–µ —É–∫–∞–∑–∞–Ω–æ¬ª.

- –ú–µ–Ω–µ–¥–∂–µ—Ä
- –ö–∞–Ω–∞–ª –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
- –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –¥–∏–∞–ª–æ–≥–∞
- –≠—Ç–∞–ø –≤–æ—Ä–æ–Ω–∫–∏
- –°–≤—è–∑—å —Å CRM (—Å–¥–µ–ª–∫–∞ / –∫–æ–Ω—Ç–∞–∫—Ç)
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å)

--------------------------------
L1. –§–æ—Ä–º–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
--------------------------------
–û—Ç–≤–µ—Ç —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: –î–∞ / –ù–µ—Ç / –ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ

- –ë—ã–ª–æ –ª–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
- –ë—ã–ª–æ –ª–∏ –ø—Ä–æ—â–∞–Ω–∏–µ
- –ë—ã–ª –ª–∏ –≤–µ–∂–ª–∏–≤—ã–π –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–æ–Ω
- –ë—ã–ª –ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∏–ª–∏ –Ω–µ–≥–∞—Ç–∏–≤
- –û—Ç–≤–µ—á–∞–ª –ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ —Å—É—Ç–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞
- –ë—ã–ª–æ –ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ —Å–ª–µ–¥—É—é—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ (CTA)

--------------------------------
L2. –†–∞–±–æ—Ç–∞ —Å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º–∏
--------------------------------
–§–∏–∫—Å–∏—Ä—É–π —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç—ã, –∞ –Ω–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è.

- –ë—ã–ª–∏ –ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∫ –∫–ª–∏–µ–Ω—Ç—É
- –£—Ç–æ—á–Ω—è–ª–∏—Å—å –ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
- –ë—ã–ª–∏ –ª–∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞
- –ï—Å—Ç—å –ª–∏ –¥–≤–∏–∂–µ–Ω–∏–µ –æ—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞ –∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—é —Ä–µ—à–µ–Ω–∏—è

--------------------------------
L3. –†–∞–±–æ—Ç–∞ —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è–º–∏
--------------------------------
–ï—Å–ª–∏ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π –Ω–µ –±—ã–ª–æ ‚Äî —É–∫–∞–∂–∏ —ç—Ç–æ —è–≤–Ω–æ.

- –ë—ã–ª–∏ –ª–∏ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –∫–ª–∏–µ–Ω—Ç–∞
- –ë—ã–ª–∞ –ª–∏ –ø–æ–ø—ã—Ç–∫–∞ –æ—Ç—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π
- –ë—ã–ª–∏ –ª–∏ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç—ã
- –¢–∏–ø –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π (–µ—Å–ª–∏ –º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å: —Ü–µ–Ω–∞ / —Å—Ä–æ–∫ / —Å–æ–º–Ω–µ–Ω–∏–µ / –¥—Ä—É–≥–æ–µ)

--------------------------------
L4. –ò–Ω—Ç–µ—Ä–µ—Å –∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
--------------------------------

- –ü—Ä–æ—è–≤–ª—è–µ—Ç –ª–∏ –∫–ª–∏–µ–Ω—Ç –∏–Ω—Ç–µ—Ä–µ—Å
- –ì–æ—Ç–æ–≤ –ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –¥–∏–∞–ª–æ–≥
- –ó–∞–ø—Ä–∞—à–∏–≤–∞–ª –ª–∏ –∫–ª–∏–µ–Ω—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- –°–æ–≥–ª–∞—Å–∏–ª—Å—è –ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥

--------------------------------
L5. –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–∏–∞–ª–æ–≥–∞
--------------------------------

- –î–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à—ë–Ω –∏–ª–∏ –Ω–µ—Ç
- –ï—Å—Ç—å –ª–∏ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å
- –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –ª–∏ —Å–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç
- –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å: –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ / –ø–∞—É–∑–∞ / –æ—Ç–∫–∞–∑ / –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ

--------------------------------
L6. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —á–∞—Ç—É
--------------------------------

–î–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, —Å–æ–±–ª—é–¥–∞—è –ø—Ä–∞–≤–∏–ª–∞:
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–µ–¥–º–µ—Ç–Ω—ã–º–∏ –∏ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º–∏ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –º–æ–º–µ–Ω—Ç–∞–º –¥–∏–∞–ª–æ–≥–∞.
- –ó–∞–ø—Ä–µ—â–µ–Ω—ã –æ–±—â–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ (¬´–Ω—É–∂–Ω–æ –ª—É—á—à–µ¬ª, ¬´—Å—Ç–æ–∏—Ç –±–æ–ª—å—à–µ¬ª).
- –ö–∞–∂–¥–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–∏–º–µ–Ω–∏–º–∞ –∫ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º —á–∞—Ç–∞–º.
- –ï—Å–ª–∏ –≤—Å—ë —Å–¥–µ–ª–∞–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚Äî —É–∫–∞–∂–∏ —ç—Ç–æ –ø—Ä—è–º–æ.

–§–æ—Ä–º–∞—Ç:
- –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ —Ö–æ—Ä–æ—à–æ
- –ß—Ç–æ –±—ã–ª–æ —É–ø—É—â–µ–Ω–æ
- –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –≤ —ç—Ç–æ–º —á–∞—Ç–µ

--------------------------------
–§–û–†–ú–ê–¢ –í–´–í–û–î–ê
--------------------------------

–í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –≤–∏–¥–µ JSON —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –∫–ª—é—á–∞–º–∏:

{
    "l0_context": {
        "manager": "–∏–º—è –∏–ª–∏ id –º–µ–Ω–µ–¥–∂–µ—Ä–∞",
        "channel": "whatsapp/telegram/viber/etc",
        "datetime": "–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è",
        "funnel_stage": "—Ö–æ–ª–æ–¥/—Ç–µ–ø–ª–æ/–≥–æ—Ä—è—á–∏–π",
        "crm_link": "—Å—Å—ã–ª–∫–∞ –Ω–∞ —Å–¥–µ–ª–∫—É/–∫–æ–Ω—Ç–∞–∫—Ç",
        "avg_response_time": "—Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö"
    },
    "l1_formal_actions": {
        "greeting": "–î–∞/–ù–µ—Ç/–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
        "farewell": "–î–∞/–ù–µ—Ç/–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
        "polite_tone": "–î–∞/–ù–µ—Ç/–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
        "conflict": "–î–∞/–ù–µ—Ç/–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
        "answered_substantively": "–î–∞/–ù–µ—Ç/–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
        "cta_proposed": "–î–∞/–ù–µ—Ç/–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"
    },
    "l2_needs_work": {
        "questions_to_client": "–î–∞/–ù–µ—Ç/–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
        "request_parameters_clarified": "–î–∞/–ù–µ—Ç/–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
        "needs_recorded": "–î–∞/–ù–µ—Ç/–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
        "movement_to_solution": "–î–∞/–ù–µ—Ç/–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"
    },
    "l3_objections_work": {
        "objections_exist": "–î–∞/–ù–µ—Ç/–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
        "objection_handling_attempt": "–î–∞/–ù–µ—Ç/–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
        "objections_closed": "–î–∞/–ù–µ—Ç/–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
        "objection_type": "—Ü–µ–Ω–∞/—Å—Ä–æ–∫/—Å–æ–º–Ω–µ–Ω–∏–µ/–¥—Ä—É–≥–æ–µ/–Ω–µ—Ç"
    },
    "l4_client_interest": {
        "client_shows_interest": "–î–∞/–ù–µ—Ç/–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
        "client_willing_to_continue": "–î–∞/–ù–µ—Ç/–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
        "client_requested_info": "–î–∞/–ù–µ—Ç/–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
        "client_agreed_next_step": "–î–∞/–ù–µ—Ç/–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"
    },
    "l5_dialog_result": {
        "dialog_completed": "–î–∞/–ù–µ—Ç/–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
        "agreement_exists": "–î–∞/–ù–µ—Ç/–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
        "next_contact_scheduled": "–î–∞/–ù–µ—Ç/–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
        "final_status": "–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ/–ø–∞—É–∑–∞/–æ—Ç–∫–∞–∑/–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"
    },
    "l6_recommendations": {
        "done_well": ["–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ 1", "—Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ 2"],
        "missed_opportunities": ["—á—Ç–æ —É–ø—É—â–µ–Ω–æ 1", "—á—Ç–æ —É–ø—É—â–µ–Ω–æ 2"],
        "improvements": ["–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ 1", "—É–ª—É—á—à–µ–Ω–∏–µ 2"]
    },
    "summary_score": 0-100
}

–ë–µ–∑ –≤–æ–¥—ã –∏ –ª–∏—Ä–∏–∫–∏.
–ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏ –≤—Å–µ–≥–¥–∞ –∫—Ä–∞—Ç–∫–æ –ø–æ—è—Å–Ω—è–π –∏—Ö.
–ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã.
–ù–µ —Å–º—è–≥—á–∞–π –≤—ã–≤–æ–¥—ã.
–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–∞–∫ –ø—Ä–æ–¥—É–∫—Ç, –∞ –Ω–µ –∫–∞–∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç."""
        
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
        meta_info = ""
        if metadata:
            meta_info = f"\n–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞:\n"
            for key, value in metadata.items():
                meta_info += f"- {key}: {value}\n"
        
        # –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
        response_time = calculate_average_response_time(messages)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –≤ –ø—Ä–æ–º–ø—Ç
        user_prompt = f"""{formatted_chat}

{meta_info}

–í—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞: {response_time}
- –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {len(messages)}
- –°–æ–æ–±—â–µ–Ω–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä–∞: {len([m for m in messages if m.get('role') == 'manager'])}
- –°–æ–æ–±—â–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞: {len([m for m in messages if m.get('role') == 'client'])}

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç –¥–∏–∞–ª–æ–≥ –ø–æ –≤—Å–µ–º —Å–ª–æ—è–º (L0-L6) —Å—Ç—Ä–æ–≥–æ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ JSON."""
        
        # API –∑–∞–ø—Ä–æ—Å - –ò–°–ü–†–ê–í–õ–ï–ù–û!
        client = openai.OpenAI(
            api_key=OPENAI_API_KEY,
            timeout=60.0
        )
        
        response = client.chat.completions.create(
            model=OPENAI_MODEL,
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            temperature=0.1,
            max_tokens=2000,
            response_format={"type": "json_object"}
        )
        
        # –ü–∞—Ä—Å–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        result_text = response.choices[0].message.content
        result = json.loads(result_text)
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ–±–æ–≥–∞—â–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        validated_result = validate_and_enrich_pro_analysis(result, messages, metadata)
        
        logger.info(f"‚úÖ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω. –°—á–µ—Ç: {validated_result.get('summary_score', 0)}")
        
        return validated_result
        
    except json.JSONDecodeError as e:
        logger.error(f"‚ùå JSON parsing error: {e}")
        return create_pro_error_response(f"JSON parsing error: {str(e)}")
    except openai.APIConnectionError as e:
        logger.error(f"‚ùå OpenAI connection error: {e}")
        return create_pro_error_response(f"OpenAI connection error: {str(e)}")
    except Exception as e:
        logger.error(f"‚ùå Professional analysis error: {e}")
        return create_pro_error_response(f"Analysis error: {str(e)}")

def format_chat_for_pro_analysis(messages: List[Dict[str, Any]]) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∏–∞–ª–æ–≥ –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞"""
    lines = [
        "=" * 80,
        "–î–ò–ê–õ–û–ì –ú–ï–ù–ï–î–ñ–ï–†–ê –° –ö–õ–ò–ï–ù–¢–û–ú (–ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –û–ö–ö)",
        "=" * 80,
        ""
    ]
    
    for i, msg in enumerate(messages, 1):
        role = "üë®‚Äçüíº –ú–ï–ù–ï–î–ñ–ï–†" if msg.get("role") == "manager" else "üë§ –ö–õ–ò–ï–ù–¢"
        text = msg.get("text", "")
        timestamp = msg.get("timestamp", "")
        
        time_str = f" [{timestamp}]" if timestamp else ""
        lines.append(f"{i}. {role}{time_str}:")
        lines.append(f"   \"{text}\"")
        lines.append("")
    
    lines.append("=" * 80)
    
    return "\n".join(lines)

def calculate_average_response_time(messages: List[Dict[str, Any]]) -> str:
    """–í—ã—á–∏—Å–ª—è–µ—Ç —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞"""
    try:
        # –§–∏–ª—å—Ç—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Å —Ç–∞–π–º—Å—Ç–µ–º–ø–∞–º–∏
        manager_messages = []
        for msg in messages:
            if msg.get("role") == "manager" and msg.get("timestamp"):
                try:
                    if isinstance(msg["timestamp"], str):
                        dt = datetime.fromisoformat(msg["timestamp"].replace('Z', '+00:00'))
                    elif isinstance(msg["timestamp"], (int, float)):
                        dt = datetime.fromtimestamp(msg["timestamp"])
                    else:
                        continue
                    manager_messages.append((dt, msg.get("text", "")))
                except:
                    continue
        
        if len(manager_messages) < 2:
            return "–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö"
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
        manager_messages.sort(key=lambda x: x[0])
        
        # –ù–∞—Ö–æ–¥–∏–º –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ—Å–ª–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞
        response_times = []
        last_client_message_time = None
        
        for msg in messages:
            if msg.get("role") == "client" and msg.get("timestamp"):
                try:
                    if isinstance(msg["timestamp"], str):
                        dt = datetime.fromisoformat(msg["timestamp"].replace('Z', '+00:00'))
                    elif isinstance(msg["timestamp"], (int, float)):
                        dt = datetime.fromtimestamp(msg["timestamp"])
                    else:
                        continue
                    last_client_message_time = dt
                except:
                    continue
            elif msg.get("role") == "manager" and msg.get("timestamp") and last_client_message_time:
                try:
                    if isinstance(msg["timestamp"], str):
                        dt = datetime.fromisoformat(msg["timestamp"].replace('Z', '+00:00'))
                    elif isinstance(msg["timestamp"], (int, float)):
                        dt = datetime.fromtimestamp(msg["timestamp"])
                    else:
                        continue
                    
                    response_time = (dt - last_client_message_time).total_seconds() / 60  # –≤ –º–∏–Ω—É—Ç–∞—Ö
                    if response_time > 0:
                        response_times.append(response_time)
                    last_client_message_time = None
                except:
                    continue
        
        if response_times:
            avg_time = sum(response_times) / len(response_times)
            return f"{avg_time:.1f} –º–∏–Ω—É—Ç"
        else:
            return "–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö"
            
    except Exception as e:
        logger.debug(f"Response time calculation error: {e}")
        return "–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö"

def validate_and_enrich_pro_analysis(result: Dict[str, Any], messages: List[Dict], metadata: Dict = None) -> Dict[str, Any]:
    """–í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ–±–æ–≥–∞—â–µ–Ω–∏–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞"""
    
    # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤—Å–µ —Å–ª–æ–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
    required_layers = [
        "l0_context", "l1_formal_actions", "l2_needs_work", 
        "l3_objections_work", "l4_client_interest", 
        "l5_dialog_result", "l6_recommendations"
    ]
    
    for layer in required_layers:
        if layer not in result:
            result[layer] = {}
    
    # –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –µ—Å—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    if metadata and "l0_context" in result:
        for key, value in metadata.items():
            if key in ["manager", "channel", "datetime", "funnel_stage", "crm_link"]:
                result["l0_context"][key] = value
    
    # –î–æ–±–∞–≤–ª—è–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    if "l0_context" in result:
        if "avg_response_time" not in result["l0_context"]:
            result["l0_context"]["avg_response_time"] = calculate_average_response_time(messages)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        result["l0_context"]["message_count"] = len(messages)
        result["l0_context"]["manager_message_count"] = len([m for m in messages if m.get("role") == "manager"])
        result["l0_context"]["client_message_count"] = len([m for m in messages if m.get("role") == "client"])
    
    # –í—ã—á–∏—Å–ª—è–µ–º summary_score –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if "summary_score" not in result:
        result["summary_score"] = calculate_pro_score(result)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –∞–Ω–∞–ª–∏–∑–∞
    result["analysis_timestamp"] = datetime.now().isoformat()
    result["model_used"] = OPENAI_MODEL
    
    # –î–æ–±–∞–≤–ª—è–µ–º ID —á–∞—Ç–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
    if metadata and "chat_id" in metadata:
        result["chat_id"] = metadata["chat_id"]
    
    return result

def calculate_pro_score(analysis: Dict[str, Any]) -> int:
    """–í—ã—á–∏—Å–ª—è–µ—Ç –æ–±—â–∏–π —Å—á–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞"""
    score = 50  # –ë–∞–∑–æ–≤—ã–π —Å—á–µ—Ç
    
    try:
        # L1: –§–æ—Ä–º–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–º–∞–∫—Å +20)
        l1 = analysis.get("l1_formal_actions", {})
        if l1.get("greeting") == "–î–∞":
            score += 3
        if l1.get("farewell") == "–î–∞":
            score += 3
        if l1.get("polite_tone") == "–î–∞":
            score += 4
        if l1.get("answered_substantively") == "–î–∞":
            score += 5
        if l1.get("cta_proposed") == "–î–∞":
            score += 5
        
        # L2: –†–∞–±–æ—Ç–∞ —Å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º–∏ (–º–∞–∫—Å +15)
        l2 = analysis.get("l2_needs_work", {})
        if l2.get("questions_to_client") == "–î–∞":
            score += 4
        if l2.get("request_parameters_clarified") == "–î–∞":
            score += 4
        if l2.get("movement_to_solution") == "–î–∞":
            score += 7
        
        # L4: –ò–Ω—Ç–µ—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞ (–º–∞–∫—Å +10)
        l4 = analysis.get("l4_client_interest", {})
        if l4.get("client_shows_interest") == "–î–∞":
            score += 5
        if l4.get("client_agreed_next_step") == "–î–∞":
            score += 5
        
        # L5: –†–µ–∑—É–ª—å—Ç–∞—Ç (–º–∞–∫—Å +15)
        l5 = analysis.get("l5_dialog_result", {})
        if l5.get("agreement_exists") == "–î–∞":
            score += 7
        if l5.get("next_contact_scheduled") == "–î–∞":
            score += 8
        
        # –®—Ç—Ä–∞—Ñ—ã
        if l1.get("conflict") == "–î–∞":
            score -= 10
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –æ—Ç 0 –¥–æ 100
        score = max(0, min(100, score))
        
    except:
        score = 50  # –ü—Ä–∏ –æ—à–∏–±–∫–µ - –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Å—á–µ—Ç
    
    return score

def create_pro_error_response(error_message: str) -> Dict[str, Any]:
    """–°–æ–∑–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ–± –æ—à–∏–±–∫–µ –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞"""
    return {
        "error": True,
        "error_message": error_message,
        "l0_context": {
            "manager": "–Ω–µ —É–∫–∞–∑–∞–Ω–æ",
            "channel": "–Ω–µ —É–∫–∞–∑–∞–Ω–æ",
            "datetime": "–Ω–µ —É–∫–∞–∑–∞–Ω–æ",
            "funnel_stage": "–Ω–µ —É–∫–∞–∑–∞–Ω–æ",
            "crm_link": "–Ω–µ —É–∫–∞–∑–∞–Ω–æ",
            "avg_response_time": "–Ω–µ —É–∫–∞–∑–∞–Ω–æ"
        },
        "l1_formal_actions": {
            "greeting": "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
            "farewell": "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
            "polite_tone": "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
            "conflict": "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
            "answered_substantively": "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
            "cta_proposed": "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"
        },
        "l2_needs_work": {
            "questions_to_client": "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
            "request_parameters_clarified": "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
            "needs_recorded": "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
            "movement_to_solution": "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"
        },
        "l3_objections_work": {
            "objections_exist": "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
            "objection_handling_attempt": "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
            "objections_closed": "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
            "objection_type": "–Ω–µ—Ç"
        },
        "l4_client_interest": {
            "client_shows_interest": "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
            "client_willing_to_continue": "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
            "client_requested_info": "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
            "client_agreed_next_step": "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"
        },
        "l5_dialog_result": {
            "dialog_completed": "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
            "agreement_exists": "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
            "next_contact_scheduled": "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ",
            "final_status": "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"
        },
        "l6_recommendations": {
            "done_well": [],
            "missed_opportunities": ["–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: " + error_message],
            "improvements": ["–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ò–ò"]
        },
        "summary_score": 0,
        "analysis_timestamp": datetime.now().isoformat()
    }

def convert_to_table_row(analysis: Dict[str, Any], chat_id: str = "") -> Dict[str, Any]:
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –∞–Ω–∞–ª–∏–∑ –≤ —Å—Ç—Ä–æ–∫—É —Ç–∞–±–ª–∏—Ü—ã —Å —Ä—É—Å—Å–∫–∏–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –∫–æ–ª–æ–Ω–æ–∫"""
    
    if analysis.get("error"):
        return {
            "ID —á–∞—Ç–∞": chat_id,
            "–û—à–∏–±–∫–∞": analysis.get("error_message", "Unknown error"),
            "–û–±—â–∏–π —Å—á–µ—Ç": 0
        }
    
    row = {}
    
    # –ë–∞–∑–æ–≤—ã–µ –ø–æ–ª—è
    row["ID —á–∞—Ç–∞"] = chat_id or analysis.get("chat_id", "")
    row["–û–±—â–∏–π —Å—á–µ—Ç"] = analysis.get("summary_score", 0)
    row["–í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞"] = analysis.get("analysis_timestamp", "")
    
    # L0: –ö–æ–Ω—Ç–µ–∫—Å—Ç
    l0 = analysis.get("l0_context", {})
    row["–ú–µ–Ω–µ–¥–∂–µ—Ä"] = l0.get("manager", "–Ω–µ —É–∫–∞–∑–∞–Ω–æ")
    row["–ö–∞–Ω–∞–ª"] = l0.get("channel", "–Ω–µ —É–∫–∞–∑–∞–Ω–æ")
    row["–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è"] = l0.get("datetime", "–Ω–µ —É–∫–∞–∑–∞–Ω–æ")
    row["–≠—Ç–∞–ø –≤–æ—Ä–æ–Ω–∫–∏"] = l0.get("funnel_stage", "–Ω–µ —É–∫–∞–∑–∞–Ω–æ")
    row["–°—Å—ã–ª–∫–∞ CRM"] = l0.get("crm_link", "–Ω–µ —É–∫–∞–∑–∞–Ω–æ")
    row["–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞"] = l0.get("avg_response_time", "–Ω–µ —É–∫–∞–∑–∞–Ω–æ")
    row["–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π"] = l0.get("message_count", 0)
    row["–°–æ–æ–±—â–µ–Ω–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä–∞"] = l0.get("manager_message_count", 0)
    row["–°–æ–æ–±—â–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞"] = l0.get("client_message_count", 0)
    
    # L1: –§–æ—Ä–º–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    l1 = analysis.get("l1_formal_actions", {})
    row["–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ"] = map_yes_no(l1.get("greeting", "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"))
    row["–ü—Ä–æ—â–∞–Ω–∏–µ"] = map_yes_no(l1.get("farewell", "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"))
    row["–í–µ–∂–ª–∏–≤—ã–π —Ç–æ–Ω"] = map_yes_no(l1.get("polite_tone", "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"))
    row["–ö–æ–Ω—Ñ–ª–∏–∫—Ç"] = map_yes_no(l1.get("conflict", "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"))
    row["–û—Ç–≤–µ—Ç –ø–æ —Å—É—Ç–∏"] = map_yes_no(l1.get("answered_substantively", "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"))
    row["–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–æ CTA"] = map_yes_no(l1.get("cta_proposed", "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"))
    
    # L2: –†–∞–±–æ—Ç–∞ —Å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º–∏
    l2 = analysis.get("l2_needs_work", {})
    row["–í–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç—É"] = map_yes_no(l2.get("questions_to_client", "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"))
    row["–£—Ç–æ—á–Ω–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"] = map_yes_no(l2.get("request_parameters_clarified", "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"))
    row["–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏"] = map_yes_no(l2.get("needs_recorded", "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"))
    row["–î–≤–∏–∂–µ–Ω–∏–µ –∫ —Ä–µ—à–µ–Ω–∏—é"] = map_yes_no(l2.get("movement_to_solution", "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"))
    
    # L3: –†–∞–±–æ—Ç–∞ —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è–º–∏
    l3 = analysis.get("l3_objections_work", {})
    row["–í–æ–∑—Ä–∞–∂–µ–Ω–∏—è –±—ã–ª–∏"] = map_yes_no(l3.get("objections_exist", "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"))
    row["–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç—Ä–∞–±–æ—Ç–∞—Ç—å"] = map_yes_no(l3.get("objection_handling_attempt", "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"))
    row["–í–æ–∑—Ä–∞–∂–µ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç—ã"] = map_yes_no(l3.get("objections_closed", "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"))
    row["–¢–∏–ø –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π"] = map_objection_type(l3.get("objection_type", "–Ω–µ—Ç"))
    
    # L4: –ò–Ω—Ç–µ—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞
    l4 = analysis.get("l4_client_interest", {})
    row["–ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—è–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å"] = map_yes_no(l4.get("client_shows_interest", "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"))
    row["–ö–ª–∏–µ–Ω—Ç –≥–æ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å"] = map_yes_no(l4.get("client_willing_to_continue", "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"))
    row["–ö–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–æ—Å–∏–ª –∏–Ω—Ñ–æ"] = map_yes_no(l4.get("client_requested_info", "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"))
    row["–ö–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–∏–ª—Å—è –Ω–∞ —à–∞–≥"] = map_yes_no(l4.get("client_agreed_next_step", "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"))
    
    # L5: –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–∏–∞–ª–æ–≥–∞
    l5 = analysis.get("l5_dialog_result", {})
    row["–î–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à–µ–Ω"] = map_yes_no(l5.get("dialog_completed", "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"))
    row["–î–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å –µ—Å—Ç—å"] = map_yes_no(l5.get("agreement_exists", "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"))
    row["–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç"] = map_yes_no(l5.get("next_contact_scheduled", "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ"))
    row["–ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å"] = map_final_status(l5.get("final_status", "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"))
    
    # L6: –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–æ–±—ä–µ–¥–∏–Ω—è–µ–º –≤ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã)
    l6 = analysis.get("l6_recommendations", {})
    row["–°–¥–µ–ª–∞–Ω–æ —Ö–æ—Ä–æ—à–æ"] = " | ".join(l6.get("done_well", []))
    row["–£–ø—É—â–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏"] = " | ".join(l6.get("missed_opportunities", []))
    row["–£–ª—É—á—à–µ–Ω–∏—è"] = " | ".join(l6.get("improvements", []))
    
    # –ú–æ–¥–µ–ª—å
    row["–ú–æ–¥–µ–ª—å –ò–ò"] = analysis.get("model_used", OPENAI_MODEL)
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞—Å—á–µ—Ç–Ω—ã–µ –ø–æ–ª—è
    row["–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"] = calculate_efficiency(row)
    row["–ö–∞—Ç–µ–≥–æ—Ä–∏—è"] = get_score_category(row.get("–û–±—â–∏–π —Å—á–µ—Ç", 0))
    
    return row

def map_yes_no(value: str) -> str:
    """–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –î–∞/–ù–µ—Ç/–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ –≤ –ø–æ–Ω—è—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç"""
    mapping = {
        "–î–∞": "‚úÖ –î–∞",
        "–ù–µ—Ç": "‚ùå –ù–µ—Ç", 
        "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º–æ": "‚ùì –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö",
        "Yes": "‚úÖ –î–∞",
        "No": "‚ùå –ù–µ—Ç",
        "Undefined": "‚ùì –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
    }
    return mapping.get(value, value)

def map_objection_type(value: str) -> str:
    """–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ç–∏–ø –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π"""
    mapping = {
        "—Ü–µ–Ω–∞": "üí∞ –¶–µ–Ω–∞",
        "—Å—Ä–æ–∫": "‚è∞ –°—Ä–æ–∫",
        "—Å–æ–º–Ω–µ–Ω–∏–µ": "ü§î –°–æ–º–Ω–µ–Ω–∏–µ", 
        "–¥—Ä—É–≥–æ–µ": "üìå –î—Ä—É–≥–æ–µ",
        "–Ω–µ—Ç": "‚ûñ –ù–µ—Ç –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π",
        "price": "üí∞ –¶–µ–Ω–∞",
        "timing": "‚è∞ –°—Ä–æ–∫",
        "doubt": "ü§î –°–æ–º–Ω–µ–Ω–∏–µ",
        "other": "üìå –î—Ä—É–≥–æ–µ",
        "none": "‚ûñ –ù–µ—Ç –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π"
    }
    return mapping.get(value, value)

def map_final_status(value: str) -> str:
    """–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å"""
    mapping = {
        "–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ": "üîÑ –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ",
        "–ø–∞—É–∑–∞": "‚è∏Ô∏è –ü–∞—É–∑–∞", 
        "–æ—Ç–∫–∞–∑": "‚ùå –û—Ç–∫–∞–∑",
        "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ": "‚ùì –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ",
        "continuation": "üîÑ –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ",
        "pause": "‚è∏Ô∏è –ü–∞—É–∑–∞",
        "rejection": "‚ùå –û—Ç–∫–∞–∑",
        "undefined": "‚ùì –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"
    }
    return mapping.get(value, value)

def calculate_efficiency(row: Dict[str, Any]) -> str:
    """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫"""
    try:
        score = 0
        total = 0
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
        metrics = {
            "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ": 1,
            "–ü—Ä–æ—â–∞–Ω–∏–µ": 1,
            "–í–µ–∂–ª–∏–≤—ã–π —Ç–æ–Ω": 2,
            "–û—Ç–≤–µ—Ç –ø–æ —Å—É—Ç–∏": 2,
            "–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–æ CTA": 2,
            "–í–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç—É": 1,
            "–î–≤–∏–∂–µ–Ω–∏–µ –∫ —Ä–µ—à–µ–Ω–∏—é": 2,
            "–ö–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–∏–ª—Å—è –Ω–∞ —à–∞–≥": 2,
            "–î–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å –µ—Å—Ç—å": 2
        }
        
        for metric, weight in metrics.items():
            if metric in row:
                value = row[metric]
                if "‚úÖ" in value:
                    score += weight
                total += weight
        
        if total == 0:
            return "‚ùì –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
        
        efficiency = (score / total) * 100
        
        if efficiency >= 80:
            return f"üéØ –û—Ç–ª–∏—á–Ω–æ ({efficiency:.0f}%)"
        elif efficiency >= 60:
            return f"üëç –•–æ—Ä–æ—à–æ ({efficiency:.0f}%)"
        elif efficiency >= 40:
            return f"üëå –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ ({efficiency:.0f}%)"
        else:
            return f"‚ö†Ô∏è –ù—É–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å ({efficiency:.0f}%)"
            
    except:
        return "‚ùì –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞"

def get_score_category(score: int) -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ —Å—á–µ—Ç—É"""
    if score >= 80:
        return "üéØ –û—Ç–ª–∏—á–Ω–æ"
    elif score >= 60:
        return "üëç –•–æ—Ä–æ—à–æ"
    elif score >= 40:
        return "üëå –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ"
    else:
        return "‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è"

def get_table_headers() -> List[str]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º"""
    return [
        "ID —á–∞—Ç–∞",
        "–û–±—â–∏–π —Å—á–µ—Ç",
        "–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
        "–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",
        "–í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞",
        "–ú–µ–Ω–µ–¥–∂–µ—Ä",
        "–ö–∞–Ω–∞–ª",
        "–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è",
        "–≠—Ç–∞–ø –≤–æ—Ä–æ–Ω–∫–∏",
        "–°—Å—ã–ª–∫–∞ CRM",
        "–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞",
        "–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π",
        "–°–æ–æ–±—â–µ–Ω–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä–∞",
        "–°–æ–æ–±—â–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞",
        "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ",
        "–ü—Ä–æ—â–∞–Ω–∏–µ",
        "–í–µ–∂–ª–∏–≤—ã–π —Ç–æ–Ω",
        "–ö–æ–Ω—Ñ–ª–∏–∫—Ç",
        "–û—Ç–≤–µ—Ç –ø–æ —Å—É—Ç–∏",
        "–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–æ CTA",
        "–í–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç—É",
        "–£—Ç–æ—á–Ω–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã",
        "–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏",
        "–î–≤–∏–∂–µ–Ω–∏–µ –∫ —Ä–µ—à–µ–Ω–∏—é",
        "–í–æ–∑—Ä–∞–∂–µ–Ω–∏—è –±—ã–ª–∏",
        "–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç—Ä–∞–±–æ—Ç–∞—Ç—å",
        "–í–æ–∑—Ä–∞–∂–µ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç—ã",
        "–¢–∏–ø –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π",
        "–ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—è–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å",
        "–ö–ª–∏–µ–Ω—Ç –≥–æ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å",
        "–ö–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–æ—Å–∏–ª –∏–Ω—Ñ–æ",
        "–ö–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–∏–ª—Å—è –Ω–∞ —à–∞–≥",
        "–î–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à–µ–Ω",
        "–î–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å –µ—Å—Ç—å",
        "–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç",
        "–ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å",
        "–°–¥–µ–ª–∞–Ω–æ —Ö–æ—Ä–æ—à–æ",
        "–£–ø—É—â–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏",
        "–£–ª—É—á—à–µ–Ω–∏—è",
        "–ú–æ–¥–µ–ª—å –ò–ò"
    ]

def print_pro_analysis_table(analyses: List[Dict[str, Any]]):
    """–ü–µ—á–∞—Ç–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É —Å –∞–Ω–∞–ª–∏–∑–∞–º–∏"""
    if not analyses:
        print("‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è")
        return
    
    headers = get_table_headers()
    
    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤
    col_widths = {}
    for header in headers:
        col_widths[header] = len(header)
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —à–∏—Ä–∏–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö
    for analysis in analyses:
        row = convert_to_table_row(analysis)
        for header in headers:
            value = str(row.get(header, ""))
            col_widths[header] = max(col_widths[header], len(value))
    
    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –ø–æ–ª–µ–π
    max_width = 25
    long_columns = ["–°–¥–µ–ª–∞–Ω–æ —Ö–æ—Ä–æ—à–æ", "–£–ø—É—â–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏", "–£–ª—É—á—à–µ–Ω–∏—è"]
    for header in long_columns:
        col_widths[header] = min(col_widths[header], max_width)
    
    # –ü–µ—á–∞—Ç–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
    print("\n" + "=" * 180)
    print("üìä –¢–ê–ë–õ–ò–¶–ê –ê–ù–ê–õ–ò–ó–ê –ß–ê–¢–û–í (–û–ö–ö) - –†–£–°–°–ö–ò–ï –ù–ê–ó–í–ê–ù–ò–Ø")
    print("=" * 180)
    
    # –ü–µ—á–∞—Ç–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–ø–µ—Ä–≤—ã–µ 15)
    print("–ü–µ—Ä–≤—ã–µ 15 –∫–æ–ª–æ–Ω–æ–∫:")
    header_line = ""
    for header in headers[:15]:
        width = col_widths[header]
        header_line += f"{header:<{width}} | "
    print(header_line)
    print("-" * 180)
    
    # –ü–µ—á–∞—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ (–ø–µ—Ä–≤—ã–µ 15 –∫–æ–ª–æ–Ω–æ–∫)
    for i, analysis in enumerate(analyses, 1):
        row = convert_to_table_row(analysis)
        row_line = ""
        for header in headers[:15]:
            value = str(row.get(header, ""))
            width = col_widths[header]
            
            # –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            if len(value) > width:
                value = value[:width-3] + "..."
            
            row_line += f"{value:<{width}} | "
        
        print(f"{i:3}. {row_line}")
    
    print("=" * 180)

def export_to_csv(analyses: List[Dict[str, Any]], filename: str = "okc_analysis.csv"):
    """–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –∞–Ω–∞–ª–∏–∑—ã –≤ CSV —Ñ–∞–π–ª —Å —Ä—É—Å—Å–∫–∏–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏"""
    import csv
    
    headers = get_table_headers()
    
    with open(filename, 'w', newline='', encoding='utf-8-sig') as csvfile:
        writer = csv.DictWriter(csvfile, fieldnames=headers, delimiter=';')
        writer.writeheader()
        
        for analysis in analyses:
            row = convert_to_table_row(analysis)
            writer.writerow(row)
    
    print(f"‚úÖ –î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ {filename} ({len(analyses)} —Å—Ç—Ä–æ–∫)")
    print(f"üìä –ö–æ–ª–æ–Ω–∫–∏: {len(headers)}")
    return filename

# –¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä
if __name__ == "__main__":
    print("üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –û–ö–ö —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –æ—à–∏–±–∫–∏")
    print("=" * 60)
    
    test_chat = [
        {"role": "client", "text": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –¥–æ—Å—Ç–∞–≤–∫–∞ –ø–∏—Ü—Ü—ã", "timestamp": "2024-01-20T18:05:00"},
        {"role": "manager", "text": "–ü—Ä–∏–≤–µ—Ç! –ö–æ–Ω–µ—á–Ω–æ, –∫–∞–∫–∞—è –ø–∏—Ü—Ü–∞ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?", "timestamp": "2024-01-20T18:06:00"},
        {"role": "client", "text": "–ú–∞—Ä–≥–∞—Ä–∏—Ç–∞ 30—Å–º", "timestamp": "2024-01-20T18:07:00"},
        {"role": "manager", "text": "–û—Ç–ª–∏—á–Ω–æ! –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞ 30—Å–º - 590 —Ä—É–±. –î–æ—Å—Ç–∞–≤–∫–∞ 150 —Ä—É–±. –ò—Ç–æ–≥–æ 740 —Ä—É–±. –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏?", "timestamp": "2024-01-20T18:08:00"},
        {"role": "client", "text": "–î–æ—Ä–æ–≥–æ. –ï—Å—Ç—å —Å–∫–∏–¥–∫–∏?", "timestamp": "2024-01-20T18:09:00"},
        {"role": "manager", "text": "–î–∞, –ø—Ä–∏ –∑–∞–∫–∞–∑–µ –æ—Ç 1000 —Ä—É–± –¥–æ—Å—Ç–∞–≤–∫–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ. –ú–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç–µ –Ω–∞–ø–∏—Ç–∫–∏ –∏–ª–∏ –∑–∞–∫—É—Å–∫–∏?", "timestamp": "2024-01-20T18:10:00"},
        {"role": "client", "text": "–•–æ—Ä–æ—à–æ, –¥–æ–±–∞–≤—å—Ç–µ –∫–æ–ª—É 0.5–ª", "timestamp": "2024-01-20T18:11:00"},
        {"role": "manager", "text": "–û—Ç–ª–∏—á–Ω–æ! –ö–æ–ª–∞ 0.5–ª - 120 —Ä—É–±. –ò—Ç–æ–≥–æ 860 —Ä—É–±. –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏?", "timestamp": "2024-01-20T18:12:00"},
        {"role": "client", "text": "—É–ª. –õ–µ–Ω–∏–Ω–∞, 10, –∫–≤. 5", "timestamp": "2024-01-20T18:13:00"},
        {"role": "manager", "text": "–°–ø–∞—Å–∏–±–æ! –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω. –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ 40 –º–∏–Ω. –ñ–µ–ª–∞—é –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞!", "timestamp": "2024-01-20T18:14:00"}
    ]
    
    metadata = {
        "manager": "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤",
        "channel": "whatsapp",
        "datetime": "2024-01-20 18:05",
        "funnel_stage": "–≥–æ—Ä—è—á–∏–π",
        "crm_link": "deal_12345",
        "chat_id": "test_chat_001"
    }
    
    result = analyze_chat_pro(test_chat, metadata)
    
    if result.get("error"):
        print(f"‚ùå –û—à–∏–±–∫–∞: {result.get('error_message')}")
    else:
        print(f"‚úÖ –ê–Ω–∞–ª–∏–∑ —É—Å–ø–µ—à–µ–Ω! –°—á–µ—Ç: {result.get('summary_score', 0)}/100")
        
        # –ü–µ—á–∞—Ç–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
        analyses_list = [result]
        print_pro_analysis_table(analyses_list)
        
        # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ CSV
        export_to_csv(analyses_list, "test_okc_analysis.csv")
        
        print("\n‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω.")